<%= content_for :head do %>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<% end %>

<style>
  .ai-editor {
    --accent: #00D4AA;
    --accent-glow: rgba(0, 212, 170, 0.5);
    --bg-base: #0A0A0B;
    --bg-elevated: #111113;
    --bg-surface: #18181B;
    --border: #27272A;
    --border-bright: #3F3F46;
    --text-primary: #FAFAFA;
    --text-secondary: #A1A1AA;
    --text-muted: #71717A;
    font-family: 'Inter', system-ui, sans-serif;
  }

  .ai-editor .mono {
    font-family: 'JetBrains Mono', monospace;
  }

  /* Grain overlay */
  .grain-overlay {
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
    opacity: 0.015;
    pointer-events: none;
    z-index: 100;
  }

  /* Grid pattern */
  .grid-pattern {
    background-image:
      linear-gradient(rgba(0, 212, 170, 0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0, 212, 170, 0.03) 1px, transparent 1px);
    background-size: 32px 32px;
  }

  /* Glow effects */
  .glow-accent {
    box-shadow: 0 0 20px var(--accent-glow), 0 0 40px rgba(0, 212, 170, 0.2);
  }

  .glow-accent-subtle {
    box-shadow: 0 0 10px rgba(0, 212, 170, 0.15);
  }

  .text-glow {
    text-shadow: 0 0 20px var(--accent-glow);
  }

  /* Scrollbar */
  .tech-scrollbar::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }

  .tech-scrollbar::-webkit-scrollbar-track {
    background: var(--bg-base);
  }

  .tech-scrollbar::-webkit-scrollbar-thumb {
    background: var(--border-bright);
    border-radius: 3px;
  }

  .tech-scrollbar::-webkit-scrollbar-thumb:hover {
    background: var(--accent);
  }

  /* Pulse animation */
  @keyframes pulse-glow {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .pulse-glow {
    animation: pulse-glow 2s ease-in-out infinite;
  }

  /* Typing animation */
  @keyframes blink {
    0%, 50% { opacity: 1; }
    51%, 100% { opacity: 0; }
  }

  .cursor-blink::after {
    content: '▋';
    animation: blink 1s infinite;
    color: var(--accent);
  }

  /* Chat message animation */
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .chat-message {
    animation: slideIn 0.3s ease-out;
  }

  /* Input glow on focus */
  .input-tech:focus {
    box-shadow: 0 0 0 2px var(--accent), 0 0 20px rgba(0, 212, 170, 0.2);
    border-color: transparent;
  }

  /* Button hover glow */
  .btn-tech:hover {
    box-shadow: 0 0 20px var(--accent-glow);
  }
</style>

<div data-controller="post-editor chat editor-panels"
     data-chat-project-id-value="<%= @project&.id %>"
     data-chat-ai-model-value="<%= @project&.ai_model || 'anthropic/claude-3.5-sonnet' %>"
     data-post-editor-bots-value="<%= @telegram_bots.map { |bot| { id: bot.id, channel_name: bot.channel_name || bot.bot_username } }.to_json %>"
     data-post-editor-post-id-value="<%= @post.id %>"
     data-post-editor-remove-image-url-value="<%= @post.persisted? ? remove_image_post_path(@post) : '' %>"
     data-editor-panels-active-panel-value="preview"
     class="ai-editor h-screen flex flex-col bg-[#0A0A0B] text-[#FAFAFA]">

  <div class="grain-overlay"></div>

  <!-- Header -->
  <header class="relative h-14 border-b border-[#27272A] px-4 flex items-center justify-between bg-[#0A0A0B]/95 backdrop-blur-xl z-50">
    <!-- Accent line -->
    <div class="absolute bottom-0 left-0 right-0 h-px bg-gradient-to-r from-transparent via-[#00D4AA]/50 to-transparent"></div>

    <div class="flex items-center gap-4">
      <%= link_to posts_path, class: "group flex items-center gap-2 px-3 py-1.5 rounded-lg text-[#A1A1AA] hover:text-[#00D4AA] hover:bg-[#00D4AA]/10 transition-all" do %>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
        </svg>
        <span class="text-sm hidden sm:inline">Назад</span>
      <% end %>

      <div class="flex items-center gap-3">
        <div class="relative">
          <div class="absolute inset-0 bg-[#00D4AA]/30 rounded-lg blur-md"></div>
          <div class="relative w-8 h-8 bg-gradient-to-br from-[#00D4AA] to-[#00A896] rounded-lg flex items-center justify-center">
            <svg class="w-4 h-4 text-[#0A0A0B]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
            </svg>
          </div>
        </div>
        <div>
          <h1 class="text-base font-semibold tracking-tight">AI Редактор</h1>
          <p class="text-[10px] text-[#00D4AA] mono tracking-widest uppercase">Neural Content Engine</p>
        </div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <!-- Status indicator -->
      <div class="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-[#111113] border border-[#27272A] rounded-lg mr-2">
        <span class="w-2 h-2 bg-[#00D4AA] rounded-full pulse-glow"></span>
        <span class="text-xs text-[#A1A1AA] mono">ONLINE</span>
      </div>

      <% if @post.persisted? %>
        <%= link_to @post, class: "flex items-center gap-2 px-3 py-1.5 text-sm text-[#A1A1AA] hover:text-[#00D4AA] hover:bg-[#00D4AA]/10 rounded-lg transition-all" do %>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
          </svg>
          <span class="hidden sm:inline">Просмотр</span>
        <% end %>
      <% end %>

      <button
        data-action="click->post-editor#save"
        class="btn-tech inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-[#00D4AA] to-[#00A896] text-[#0A0A0B] rounded-lg text-sm font-semibold transition-all hover:scale-[1.02] active:scale-[0.98]"
      >
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
        </svg>
        Сохранить
      </button>
    </div>
  </header>

  <!-- Mobile Panel Tabs -->
  <nav class="lg:hidden flex border-b border-[#27272A] bg-[#0A0A0B]">
    <button type="button" data-editor-panels-target="chatTab" data-action="click->editor-panels#showChat"
            class="flex-1 flex items-center justify-center gap-2 px-4 py-3 text-sm font-medium text-[#71717A] hover:text-[#00D4AA] border-b-2 border-transparent hover:border-[#00D4AA]/50 transition-all">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
      </svg>
      <span>AI</span>
    </button>
    <button type="button" data-editor-panels-target="settingsTab" data-action="click->editor-panels#showSettings"
            class="flex-1 flex items-center justify-center gap-2 px-4 py-3 text-sm font-medium text-[#71717A] hover:text-[#00D4AA] border-b-2 border-transparent hover:border-[#00D4AA]/50 transition-all">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
      </svg>
      <span>Настройки</span>
    </button>
    <button type="button" data-editor-panels-target="previewTab" data-action="click->editor-panels#showPreview"
            class="flex-1 flex items-center justify-center gap-2 px-4 py-3 text-sm font-medium text-[#00D4AA] border-b-2 border-[#00D4AA] transition-all">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
      </svg>
      <span>Редактор</span>
    </button>
  </nav>

  <!-- Three Panel Layout -->
  <div class="flex-1 flex flex-col lg:flex-row overflow-hidden relative">

    <!-- Left Panel: AI Chat -->
    <aside data-editor-panels-target="chatPanel"
           class="hidden lg:flex lg:w-[30%] bg-[#0A0A0B] border-r border-[#27272A] flex-col relative">
      <!-- Grid pattern background -->
      <div class="absolute inset-0 grid-pattern opacity-50"></div>

      <div class="relative px-5 py-4 border-b border-[#27272A] bg-[#111113]/80">
        <div class="flex items-center gap-3">
          <div class="relative">
            <div class="absolute inset-0 bg-[#00D4AA]/20 rounded-lg blur"></div>
            <div class="relative w-9 h-9 bg-gradient-to-br from-[#00D4AA] to-[#00A896] rounded-lg flex items-center justify-center">
              <svg class="w-5 h-5 text-[#0A0A0B]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
              </svg>
            </div>
          </div>
          <div>
            <h2 class="text-sm font-semibold">Neural Assistant</h2>
            <p class="text-[10px] text-[#00D4AA] mono tracking-wider">GPT-4 • Claude 3.5 • Gemini</p>
          </div>
        </div>
      </div>

      <div class="relative flex-1 flex flex-col overflow-hidden">
        <!-- Chat Messages -->
        <div data-chat-target="messages" class="flex-1 overflow-y-auto tech-scrollbar px-5 py-5 space-y-4">
          <!-- Welcome message -->
          <div class="chat-message relative">
            <div class="absolute -left-1 top-3 w-2 h-2 bg-[#00D4AA] rounded-full glow-accent-subtle"></div>
            <div class="ml-4 p-4 bg-gradient-to-br from-[#00D4AA]/10 to-[#00D4AA]/5 border border-[#00D4AA]/20 rounded-xl">
              <p class="text-sm text-[#00D4AA] font-medium mb-2">
                <span class="mono text-[10px] uppercase tracking-wider opacity-70">SYSTEM</span>
              </p>
              <p class="text-sm text-[#FAFAFA] leading-relaxed">
                Привет! Я AI-ассистент для создания контента.
                Опиши тему поста — и я сгенерирую текст для Telegram.
              </p>
              <div class="mt-3 flex flex-wrap gap-2">
                <button class="px-2 py-1 text-[10px] mono bg-[#18181B] border border-[#27272A] rounded text-[#A1A1AA] hover:border-[#00D4AA] hover:text-[#00D4AA] transition-colors">
                  /generate продающий пост
                </button>
                <button class="px-2 py-1 text-[10px] mono bg-[#18181B] border border-[#27272A] rounded text-[#A1A1AA] hover:border-[#00D4AA] hover:text-[#00D4AA] transition-colors">
                  /improve текст
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Chat Input -->
        <div class="relative px-5 py-4 border-t border-[#27272A] bg-[#111113]/80">
          <form data-action="submit->chat#sendMessage" class="flex gap-2">
            <div class="relative flex-1">
              <input
                type="text"
                data-chat-target="input"
                placeholder="Напиши тему поста или команду..."
                class="input-tech w-full h-11 px-4 bg-[#18181B] border border-[#27272A] rounded-lg text-sm text-[#FAFAFA] placeholder:text-[#71717A] mono focus:outline-none transition-all"
              >
              <div class="absolute right-3 top-1/2 -translate-y-1/2 text-[10px] text-[#3F3F46] mono">⌘+Enter</div>
            </div>
            <button
              type="submit"
              data-chat-target="submitButton"
              class="btn-tech w-11 h-11 bg-gradient-to-r from-[#00D4AA] to-[#00A896] rounded-lg flex items-center justify-center text-[#0A0A0B] transition-all hover:scale-105 active:scale-95"
            >
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
          </form>
        </div>
      </div>
    </aside>

    <!-- Center Panel: Settings -->
    <aside data-editor-panels-target="settingsPanel"
           class="hidden lg:flex lg:w-[25%] bg-[#111113] border-r border-[#27272A] flex-col overflow-y-auto tech-scrollbar">

      <div class="px-5 py-4 border-b border-[#27272A]">
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-[#00D4AA]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
          </svg>
          <h2 class="text-sm font-semibold">Параметры</h2>
        </div>
      </div>

      <%= form_with model: @post, url: @post.persisted? ? post_path(@post) : posts_path, method: @post.persisted? ? :patch : :post, local: true, multipart: true, data: { post_editor_target: "form" }, class: "p-5 space-y-5" do |f| %>

        <!-- Project -->
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-xs font-medium text-[#A1A1AA] mono uppercase tracking-wider">
            <span class="w-1.5 h-1.5 bg-[#00D4AA] rounded-full"></span>
            Проект
          </label>
          <%= f.collection_select :project_id, current_user.projects.active, :id, :name,
              { prompt: "Выберите проект" },
              { class: "w-full h-10 px-3 bg-[#18181B] border border-[#27272A] rounded-lg text-sm text-[#FAFAFA] focus:border-[#00D4AA] focus:ring-1 focus:ring-[#00D4AA] transition-all" } %>
        </div>

        <!-- Telegram Bot -->
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-xs font-medium text-[#A1A1AA] mono uppercase tracking-wider">
            <span class="w-1.5 h-1.5 bg-blue-500 rounded-full"></span>
            Telegram канал
          </label>
          <%= f.collection_select :telegram_bot_id, @telegram_bots, :id, :display_name,
              { include_blank: "Выберите канал" },
              { data: { post_editor_target: "botSelect", action: "change->post-editor#updateChannelName" },
                class: "w-full h-10 px-3 bg-[#18181B] border border-[#27272A] rounded-lg text-sm text-[#FAFAFA] focus:border-[#00D4AA] focus:ring-1 focus:ring-[#00D4AA] transition-all" } %>
        </div>

        <!-- Title -->
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-xs font-medium text-[#A1A1AA] mono uppercase tracking-wider">
            <span class="w-1.5 h-1.5 bg-violet-500 rounded-full"></span>
            Заголовок
          </label>
          <%= f.text_field :title, placeholder: "Название поста",
              class: "w-full h-10 px-3 bg-[#18181B] border border-[#27272A] rounded-lg text-sm text-[#FAFAFA] placeholder:text-[#71717A] focus:border-[#00D4AA] focus:ring-1 focus:ring-[#00D4AA] transition-all" %>
        </div>

        <!-- Post Type -->
        <div class="space-y-2">
          <label class="flex items-center gap-2 text-xs font-medium text-[#A1A1AA] mono uppercase tracking-wider">
            <span class="w-1.5 h-1.5 bg-amber-500 rounded-full"></span>
            Тип поста
          </label>
          <%= f.select :post_type,
              [['Текстовый', 'text'], ['С изображением', 'image'], ['Изображение + Кнопка', 'image_button']],
              {},
              { data: { post_editor_target: "postType", action: "change->post-editor#toggleButtonFields" },
                class: "w-full h-10 px-3 bg-[#18181B] border border-[#27272A] rounded-lg text-sm text-[#FAFAFA] focus:border-[#00D4AA] focus:ring-1 focus:ring-[#00D4AA] transition-all" } %>
        </div>

        <!-- Image Upload -->
        <div data-post-editor-target="imageField" class="space-y-3 <%= @post.post_type == 'text' ? 'hidden' : '' %>">
          <label class="flex items-center gap-2 text-xs font-medium text-[#A1A1AA] mono uppercase tracking-wider">
            <span class="w-1.5 h-1.5 bg-pink-500 rounded-full"></span>
            Изображение
          </label>

          <div class="border border-dashed border-[#27272A] rounded-xl p-4 hover:border-[#00D4AA]/50 transition-colors">
            <%= f.file_field :image, accept: "image/*", data: { action: "change->post-editor#previewImage" },
                class: "block w-full text-sm text-[#A1A1AA] file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-[#00D4AA]/10 file:text-[#00D4AA] hover:file:bg-[#00D4AA]/20 cursor-pointer" %>
          </div>

          <% if @post.image.attached? %>
            <div class="relative rounded-xl overflow-hidden border border-[#27272A]">
              <%= image_tag @post.image, class: "w-full max-h-40 object-cover" %>
              <%= link_to "#", data: { action: "click->post-editor#removeImage" },
                  class: "absolute top-2 right-2 p-2 bg-red-500/90 backdrop-blur text-white rounded-lg text-xs font-medium hover:bg-red-600 transition-colors" do %>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
              <% end %>
            </div>
          <% end %>

          <!-- AI Image Generation -->
          <div data-controller="image-generator"
               data-image-generator-project-id-value="<%= @project&.id %>"
               data-image-generator-post-editor-outlet="[data-controller~='post-editor']"
               class="p-4 bg-gradient-to-br from-[#00D4AA]/5 to-transparent border border-[#00D4AA]/20 rounded-xl">

            <div class="flex items-center gap-2 mb-3">
              <div class="w-6 h-6 bg-gradient-to-br from-[#00D4AA] to-[#00A896] rounded-md flex items-center justify-center">
                <svg class="w-3.5 h-3.5 text-[#0A0A0B]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
              </div>
              <span class="text-xs font-medium text-[#00D4AA]">AI Image Generator</span>
            </div>

            <textarea data-image-generator-target="promptInput"
                      placeholder="Опишите изображение..."
                      rows="2"
                      class="w-full px-3 py-2 text-sm bg-[#18181B] border border-[#27272A] rounded-lg text-[#FAFAFA] placeholder:text-[#71717A] focus:border-[#00D4AA] focus:ring-1 focus:ring-[#00D4AA] resize-none transition-all"></textarea>

            <div class="flex items-center gap-2 mt-3">
              <select data-image-generator-target="aspectRatio"
                      class="h-9 px-3 text-xs bg-[#18181B] border border-[#27272A] rounded-lg text-[#FAFAFA] focus:border-[#00D4AA] focus:ring-1 focus:ring-[#00D4AA]">
                <option value="1:1">1:1</option>
                <option value="16:9">16:9</option>
                <option value="9:16">9:16</option>
              </select>

              <button type="button"
                      data-image-generator-target="generateButton"
                      data-action="click->image-generator#generate"
                      class="flex-1 h-9 bg-gradient-to-r from-[#00D4AA] to-[#00A896] text-[#0A0A0B] text-xs font-semibold rounded-lg hover:shadow-lg hover:shadow-[#00D4AA]/20 transition-all">
                Сгенерировать
              </button>
            </div>

            <div data-image-generator-target="loading" class="hidden mt-3">
              <div class="flex items-center gap-2 p-3 bg-[#00D4AA]/10 border border-[#00D4AA]/20 rounded-lg">
                <svg class="w-4 h-4 text-[#00D4AA] animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-xs text-[#00D4AA]">Генерация...</span>
              </div>
            </div>

            <div data-image-generator-target="error" class="hidden mt-3 p-3 bg-red-500/10 border border-red-500/20 rounded-lg">
              <p class="text-xs text-red-400"></p>
            </div>

            <div data-image-generator-target="preview" class="hidden mt-3">
              <div class="rounded-lg overflow-hidden border border-[#27272A]">
                <img data-image-generator-target="generatedImage" class="w-full max-h-40 object-contain bg-[#18181B]" alt="Generated" />
              </div>
              <button type="button" data-image-generator-target="applyButton" data-action="click->image-generator#applyImage"
                      class="mt-2 w-full h-9 bg-emerald-500 text-white text-xs font-semibold rounded-lg hover:bg-emerald-600 transition-colors">
                Применить
              </button>
            </div>
          </div>
        </div>

        <!-- Button Fields -->
        <div data-post-editor-target="buttonFields" class="space-y-4 <%= @post.post_type == 'image_button' ? '' : 'hidden' %>">
          <div class="space-y-2">
            <label class="text-xs font-medium text-[#A1A1AA] mono uppercase tracking-wider">Текст кнопки</label>
            <%= f.text_field :button_text, placeholder: "Перейти на сайт", maxlength: 64,
                data: { action: "input->post-editor#updateButtonText" },
                class: "w-full h-10 px-3 bg-[#18181B] border border-[#27272A] rounded-lg text-sm text-[#FAFAFA] placeholder:text-[#71717A] focus:border-[#00D4AA] focus:ring-1 focus:ring-[#00D4AA] transition-all" %>
          </div>
          <div class="space-y-2">
            <label class="text-xs font-medium text-[#A1A1AA] mono uppercase tracking-wider">Ссылка</label>
            <%= f.url_field :button_url, placeholder: "https://example.com",
                data: { action: "input->post-editor#updateButtonUrl" },
                class: "w-full h-10 px-3 bg-[#18181B] border border-[#27272A] rounded-lg text-sm text-[#FAFAFA] placeholder:text-[#71717A] focus:border-[#00D4AA] focus:ring-1 focus:ring-[#00D4AA] transition-all mono" %>
          </div>
        </div>

        <!-- AI Settings -->
        <% if @project %>
          <div class="pt-4 border-t border-[#27272A]">
            <div class="flex items-center gap-2 mb-4">
              <span class="w-1.5 h-1.5 bg-[#00D4AA] rounded-full pulse-glow"></span>
              <span class="text-xs font-medium text-[#A1A1AA] mono uppercase tracking-wider">AI Config</span>
            </div>

            <div class="space-y-4">
              <div class="space-y-2">
                <label class="text-xs text-[#71717A]">Модель</label>
                <select data-chat-target="modelSelect" data-action="change->chat#changeModel"
                        class="w-full h-9 px-3 text-xs bg-[#18181B] border border-[#27272A] rounded-lg text-[#FAFAFA] focus:border-[#00D4AA] focus:ring-1 focus:ring-[#00D4AA] mono transition-all">
                  <% Project::AI_MODELS.each do |value, label| %>
                    <option value="<%= value %>" <%= 'selected' if @project.ai_model == value %>><%= label %></option>
                  <% end %>
                </select>
              </div>

              <div class="space-y-2">
                <label class="text-xs text-[#71717A]">Стиль</label>
                <div class="flex items-center justify-between p-3 bg-[#18181B] border border-[#27272A] rounded-lg">
                  <span class="text-xs text-[#FAFAFA]"><%= @project.writing_style_name %></span>
                  <%= link_to project_style_settings_path(@project), class: "text-[10px] text-[#00D4AA] hover:underline", target: "_blank" do %>
                    Настроить →
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        <% end %>

        <%= f.hidden_field :content, data: { post_editor_target: "content" } %>
      <% end %>
    </aside>

    <!-- Right Panel: Preview & Editor -->
    <main data-editor-panels-target="previewPanel"
          class="flex-1 min-h-0 bg-[#0A0A0B] overflow-y-auto tech-scrollbar">
      <div class="max-w-3xl mx-auto px-6 py-8">

        <!-- Preview Header -->
        <div class="flex items-center justify-between mb-6">
          <div class="flex items-center gap-3">
            <h2 class="text-sm font-semibold">Превью</h2>
            <div class="flex items-center gap-2 px-2 py-1 bg-[#111113] border border-[#27272A] rounded-lg">
              <span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span>
              <span class="text-[10px] text-[#A1A1AA] mono">LIVE</span>
            </div>
          </div>
          <span data-post-editor-target="charCount" class="text-xs text-[#71717A] mono">0 / 4096</span>
        </div>

        <!-- Telegram Preview Card -->
        <div class="mb-8 rounded-2xl border border-[#27272A] overflow-hidden bg-[#111113] shadow-2xl shadow-black/20">
          <!-- Channel Header -->
          <div class="px-4 py-3 border-b border-[#18181B] bg-gradient-to-r from-[#111113] to-[#18181B]">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center shadow-lg shadow-blue-500/20">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18.717-.962 3.767-1.362 5.001-.168.52-.504.694-.826.71-.702.033-1.235-.464-1.913-.908-1.061-.695-1.662-1.127-2.693-1.805-.119-.078-.238-.158-.356-.239a.734.734 0 01.05-1.171c.294-.24 2.661-2.426 2.661-2.426s.172-.177.161-.284a.316.316 0 00-.189-.238 1.02 1.02 0 00-.373-.05c-.177.011-2.986 1.897-8.428 5.571-.797.548-1.52.815-2.165.801-.713-.016-2.082-.403-3.104-.736-.125-.041-.247-.081-.364-.121a.722.722 0 01-.437-.873c.056-.148.146-.258.256-.354.851-.748 8.666-3.758 10.818-4.677 5.112-2.186 6.184-2.568 6.876-2.58.153-.002.495.035.716.214.186.149.238.351.263.494.024.143.056.466.032.72z"/>
                </svg>
              </div>
              <div class="flex-1">
                <p data-post-editor-target="channelName" class="text-sm font-semibold">
                  <%= @post.telegram_bot&.channel_name || @telegram_bots.first&.channel_name || "Выберите канал" %>
                </p>
                <p class="text-xs text-[#71717A]"><%= Time.current.strftime("%H:%M") %></p>
              </div>
            </div>
          </div>

          <!-- Post Image -->
          <div data-post-editor-target="imagePreview" class="<%= @post.image.attached? ? '' : 'hidden' %>">
            <% if @post.image.attached? %>
              <%= image_tag @post.image, alt: "Post image", class: "w-full object-cover max-h-80" %>
            <% else %>
              <img src="" alt="Post image" class="w-full object-cover max-h-80" data-post-editor-target="imagePreviewImg" />
            <% end %>
          </div>

          <!-- Post Content -->
          <div class="px-4 py-4">
            <h3 data-post-editor-target="titlePreview" class="text-base font-bold mb-3 <%= @post.title.present? ? '' : 'hidden' %>"><%= @post.title %></h3>
            <div data-post-editor-target="preview" class="telegram-content text-[15px] leading-relaxed">
              <% if @post.content.present? %>
                <%= simple_format(@post.content, class: '') %>
              <% else %>
                <p class="text-[#71717A] italic">Начните писать или используйте AI...</p>
              <% end %>
            </div>

            <!-- Button -->
            <div data-post-editor-target="buttonPreview" class="mt-4 <%= @post.post_type == 'image_button' && @post.button_text.present? ? '' : 'hidden' %>">
              <a href="<%= @post.button_url %>" target="_blank"
                 class="inline-flex items-center justify-center w-full px-4 py-2.5 bg-blue-500 hover:bg-blue-600 text-white font-medium rounded-lg transition-colors text-sm">
                <span data-post-editor-target="buttonTextPreview"><%= @post.button_text || 'Кнопка' %></span>
              </a>
            </div>
          </div>

          <!-- Post Meta -->
          <div class="px-4 py-3 border-t border-[#18181B]">
            <div class="flex items-center justify-between text-xs text-[#71717A]">
              <div class="flex items-center gap-4">
                <span class="flex items-center gap-1.5">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                  1.2k
                </span>
                <span class="flex items-center gap-1.5">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/>
                  </svg>
                  72
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Content Editor -->
        <div class="mb-8">
          <label class="flex items-center gap-2 text-sm font-medium mb-3">
            <svg class="w-4 h-4 text-[#00D4AA]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
            </svg>
            Редактор
          </label>
          <div class="rounded-xl border border-[#27272A] bg-[#111113] overflow-hidden focus-within:border-[#00D4AA]/50 focus-within:shadow-lg focus-within:shadow-[#00D4AA]/5 transition-all">
            <textarea
              data-post-editor-target="contentEditor"
              data-action="input->post-editor#updatePreview"
              rows="14"
              placeholder="Напишите текст поста или используйте AI для генерации...

Поддерживается Markdown:
**жирный** *курсив* `код` [ссылка](url)"
              class="w-full px-5 py-4 bg-transparent text-sm text-[#FAFAFA] placeholder:text-[#3F3F46] focus:outline-none resize-none mono leading-relaxed"
            ><%= @post.content %></textarea>
          </div>
          <p class="mt-2 text-[10px] text-[#71717A] mono">Markdown • Turbo sync • Auto-save</p>
        </div>

        <!-- Quick Actions -->
        <div class="flex flex-wrap gap-2">
          <button type="button" data-action="click->post-editor#addEmoji"
                  class="inline-flex items-center gap-2 px-3 py-2 bg-[#111113] border border-[#27272A] rounded-lg text-xs text-[#A1A1AA] hover:text-[#00D4AA] hover:border-[#00D4AA]/50 transition-all">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            Эмодзи
          </button>
          <button type="button" data-action="click->post-editor#addHashtags"
                  class="inline-flex items-center gap-2 px-3 py-2 bg-[#111113] border border-[#27272A] rounded-lg text-xs text-[#A1A1AA] hover:text-[#00D4AA] hover:border-[#00D4AA]/50 transition-all">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"/>
            </svg>
            Хештеги
          </button>
          <button type="button" data-action="click->post-editor#triggerImageUpload"
                  class="inline-flex items-center gap-2 px-3 py-2 bg-[#111113] border border-[#27272A] rounded-lg text-xs text-[#A1A1AA] hover:text-[#00D4AA] hover:border-[#00D4AA]/50 transition-all">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
            </svg>
            Изображение
          </button>
        </div>

      </div>
    </main>
  </div>
</div>
