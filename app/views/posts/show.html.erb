<div class="max-w-7xl mx-auto px-4 lg:px-8 py-4 lg:py-8">
  <!-- Header -->
  <div class="mb-6">
    <%= link_to posts_path, class: "inline-flex items-center gap-2 text-xs text-muted-foreground hover:text-foreground mb-3 transition-colors" do %>
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/>
      </svg>
      Назад к постам
    <% end %>

    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
      <div>
        <h1 class="text-xl font-semibold text-foreground"><%= @post.title %></h1>
        <div class="flex items-center gap-2 mt-1">
          <% case @post.status %>
          <% when "published" %>
            <span class="px-2 py-0.5 bg-green-50 text-green-700 text-xs font-medium rounded">Опубликован</span>
          <% when "scheduled" %>
            <span class="px-2 py-0.5 bg-blue-50 text-blue-700 text-xs font-medium rounded">Запланирован</span>
          <% when "draft" %>
            <span class="px-2 py-0.5 bg-muted text-muted-foreground text-xs font-medium rounded">Черновик</span>
          <% when "failed" %>
            <span class="px-2 py-0.5 bg-red-50 text-red-700 text-xs font-medium rounded">Ошибка</span>
          <% end %>
          <% if @post.project %>
            <span class="text-xs text-muted-foreground">в <%= link_to @post.project.name, project_path(@post.project), class: "hover:text-foreground transition-colors" %></span>
          <% end %>
        </div>
      </div>
      <div class="flex items-center gap-2 w-full sm:w-auto">
        <%= link_to editor_posts_path(post_id: @post.id), class: "inline-flex h-9 items-center justify-center rounded-md border border-input bg-background px-3 py-2 text-xs font-medium ring-offset-background transition-colors hover:bg-accent hover:text-accent-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 flex-1 sm:flex-none" do %>
          Редактировать
        <% end %>
        <% if (@post.draft? || @post.failed?) && @post.telegram_bot %>
          <%= button_to publish_post_path(@post), method: :post, class: "inline-flex h-9 items-center justify-center rounded-md bg-green-600 px-3 py-2 text-xs font-semibold text-white ring-offset-background transition-colors hover:bg-green-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 flex-1 sm:flex-none" do %>
            <%= @post.failed? ? 'Повторить' : 'Опубликовать' %>
          <% end %>
        <% end %>
      </div>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
    <!-- Content -->
    <div class="lg:col-span-2 space-y-4">
      <div class="bg-card border border-border rounded-lg">
        <div class="p-4 border-b border-border">
          <h2 class="text-sm font-semibold text-foreground">Содержимое</h2>
        </div>
        <div class="p-6 prose prose-sm max-w-none">
          <%= simple_format(@post.content) %>
        </div>
      </div>

      <!-- Telegram Preview -->
      <div class="bg-gradient-to-b from-blue-400 to-blue-500 rounded-lg p-4">
        <h3 class="text-white text-xs font-medium mb-3">Превью в Telegram</h3>
        <div class="bg-white dark:bg-white rounded-lg shadow-sm overflow-hidden">
          <!-- Channel Header -->
          <div class="bg-white px-4 py-3 border-b border-zinc-200">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-blue-600 rounded-full flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0z"/>
                </svg>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-zinc-900 font-semibold text-sm truncate">
                  <%= @post.telegram_bot&.channel_name || "Ваш Канал" %>
                </p>
                <p class="text-zinc-500 text-xs"><%= @post.published_at&.strftime("%H:%M") || Time.current.strftime("%H:%M") %></p>
              </div>
            </div>
          </div>

          <!-- Post Content -->
          <div class="bg-white">
            <!-- Image (if post type is image or image_button) -->
            <% if (@post.post_type == 'image' || @post.post_type == 'image_button') && @post.image.attached? %>
              <div class="w-full">
                <%= image_tag @post.image, class: "w-full h-auto", alt: @post.title %>
              </div>
            <% end %>

            <div class="px-4 py-4">
              <div class="telegram-content text-[15px] text-zinc-900 leading-relaxed space-y-2">
                <%= raw(@post.content
                  .gsub(/\*\*(.+?)\*\*/, '<strong class="font-semibold text-zinc-900">\1</strong>')
                  .gsub(/(?<!\*)\*([^\*]+?)\*(?!\*)/, '<em class="italic">\1</em>')
                  .gsub(/`(.+?)`/, '<code class="bg-zinc-100 px-1.5 py-0.5 rounded text-[13px] font-mono text-zinc-900">\1</code>')
                  .gsub(/\[(.+?)\]\((.+?)\)/, '<a href="\2" class="text-blue-600 hover:underline font-medium">\1</a>')
                  .gsub(/\n/, '<br>')) %>
              </div>

              <!-- Button (if post type is image_button) -->
              <% if @post.post_type == 'image_button' && @post.button_text.present? %>
                <div class="mt-3">
                  <a href="<%= @post.button_url %>" target="_blank" class="inline-flex items-center justify-center w-full px-4 py-2 bg-white border border-zinc-300 rounded-lg text-blue-600 text-sm font-medium hover:bg-zinc-50 transition-colors">
                    <%= @post.button_text %>
                  </a>
                </div>
              <% end %>
            </div>
          </div>

          <!-- Post Meta -->
          <div class="bg-white px-4 py-2.5 border-t border-zinc-100">
            <div class="flex items-center justify-between text-[13px]">
              <div class="flex items-center gap-4 text-zinc-500">
                <span class="flex items-center gap-1.5">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                  <%= @post.post_analytics.sum(:views) || 0 %>
                </span>
              </div>
              <span class="font-medium <%= @post.content.length > (@post.text? ? 4096 : 1024) ? 'text-red-600' : 'text-zinc-500' %>">
                <%= @post.content.length %> / <%= @post.text? ? 4096 : 1024 %>
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="space-y-4">
      <!-- Info -->
      <div class="bg-card border border-border rounded-lg">
        <div class="p-4 border-b border-border">
          <h3 class="text-xs font-semibold text-foreground">Информация</h3>
        </div>
        <div class="p-4 space-y-3 text-xs">
          <div class="flex items-center justify-between">
            <span class="text-muted-foreground">Создан</span>
            <span class="text-foreground"><%= @post.created_at.strftime("%d.%m.%Y %H:%M") %></span>
          </div>
          <% if @post.published_at %>
            <div class="flex items-center justify-between">
              <span class="text-muted-foreground"><%= @post.published? ? 'Опубликован' : 'Запланирован на' %></span>
              <span class="text-foreground"><%= @post.published_at.strftime("%d.%m.%Y %H:%M") %></span>
            </div>
          <% end %>
          <div class="flex items-center justify-between">
            <span class="text-muted-foreground">Символов</span>
            <span class="<%= @post.content.length > (@post.text? ? 4096 : 1024) ? 'text-red-600 font-semibold' : 'text-foreground' %>">
              <%= @post.content.length %> / <%= @post.text? ? 4096 : 1024 %>
            </span>
          </div>
        </div>
      </div>

      <!-- Telegram Bot -->
      <div class="bg-card border border-border rounded-lg">
        <div class="p-4 border-b border-border">
          <h3 class="text-xs font-semibold text-foreground">Публикация</h3>
        </div>
        <div class="p-4">
          <% if @post.telegram_bot %>
            <div class="flex items-center gap-2 p-2 bg-muted rounded-md">
              <div class="w-6 h-6 bg-background rounded flex items-center justify-center">
                <svg class="w-3 h-3 text-muted-foreground" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0z"/>
                </svg>
              </div>
              <div>
                <p class="text-xs font-medium text-foreground">@<%= @post.telegram_bot.bot_username %></p>
                <p class="text-xs text-muted-foreground"><%= @post.telegram_bot.channel_name %></p>
              </div>
            </div>
          <% else %>
            <p class="text-xs text-muted-foreground mb-2">Бот не выбран</p>
            <%= link_to "Выбрать бота", edit_post_path(@post), class: "text-xs text-muted-foreground hover:text-foreground transition-colors" %>
          <% end %>
        </div>
      </div>

      <!-- Schedule -->
      <% if @post.draft? %>
        <div class="bg-card border border-border rounded-lg">
          <div class="p-4 border-b border-border">
            <h3 class="text-xs font-semibold text-foreground">Запланировать</h3>
          </div>
          <div class="p-4">
            <%= form_with url: schedule_post_path(@post), method: :post, local: true, class: "space-y-3" do %>
              <input type="datetime-local" name="scheduled_at" class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-xs ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50" min="<%= Time.current.strftime('%Y-%m-%dT%H:%M') %>">
              <p class="text-xs text-muted-foreground">Часовой пояс: <%= current_user.time_zone %></p>
              <button type="submit" class="inline-flex h-10 w-full items-center justify-center rounded-md bg-blue-600 px-4 py-2 text-xs font-semibold text-white ring-offset-background transition-colors hover:bg-blue-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2">
                Запланировать
              </button>
            <% end %>
          </div>
        </div>
      <% end %>

      <!-- Actions -->
      <div class="bg-card border border-border rounded-lg">
        <div class="p-4 border-b border-border">
          <h3 class="text-xs font-semibold text-foreground">Действия</h3>
        </div>
        <div class="p-4">
          <%= button_to post_path(@post), method: :delete, data: { turbo_confirm: "Удалить пост?" }, class: "w-full h-9 text-xs font-medium text-red-600 hover:bg-red-50 rounded-md transition-colors text-left px-2" do %>
            Удалить пост
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>
