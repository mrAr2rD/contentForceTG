<% content_for :title, @channel_site.site_title || 'Мини-сайт' %>

<div class="max-w-6xl mx-auto px-4 py-8">
  <!-- Header -->
  <div class="flex items-start justify-between mb-8">
    <div>
      <div class="flex items-center gap-2 text-sm text-zinc-500 mb-2">
        <%= link_to 'Мини-сайты', dashboard_channel_sites_path, class: 'hover:text-zinc-700 dark:hover:text-zinc-300' %>
        <span>/</span>
        <span><%= @channel_site.site_title || @channel_site.telegram_bot.channel_name %></span>
      </div>

      <h1 class="text-2xl font-bold flex items-center gap-3">
        <%= @channel_site.site_title || @channel_site.telegram_bot.channel_name %>
        <% if @channel_site.enabled? %>
          <span class="px-2 py-0.5 rounded-full bg-emerald-500/10 text-emerald-500 text-xs font-medium">
            Активен
          </span>
        <% else %>
          <span class="px-2 py-0.5 rounded-full bg-zinc-500/10 text-zinc-500 text-xs font-medium">
            Отключён
          </span>
        <% end %>
      </h1>

      <% if @channel_site.host.present? %>
        <a href="<%= @channel_site.full_url %>"
           target="_blank"
           rel="noopener noreferrer"
           class="text-emerald-500 hover:underline text-sm mt-1 inline-block">
          <%= @channel_site.host %> ↗
        </a>
      <% end %>
    </div>

    <div class="flex items-center gap-2">
      <% if @channel_site.telegram_bot.can_create_channel_site? %>
        <% if @channel_site.enabled? %>
          <%= button_to disable_dashboard_channel_site_path(@channel_site),
                        method: :post,
                        class: 'px-4 py-2 border border-zinc-300 dark:border-zinc-700 rounded-lg hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors' do %>
            Отключить
          <% end %>
        <% else %>
          <%= button_to enable_dashboard_channel_site_path(@channel_site),
                        method: :post,
                        class: 'px-4 py-2 bg-emerald-500 hover:bg-emerald-600 text-white rounded-lg transition-colors' do %>
            Включить
          <% end %>
        <% end %>

        <%= button_to sync_dashboard_channel_site_path(@channel_site),
                      method: :post,
                      class: 'px-4 py-2 border border-zinc-300 dark:border-zinc-700 rounded-lg hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors' do %>
          Синхронизировать
        <% end %>
      <% else %>
        <span class="px-4 py-2 bg-zinc-100 dark:bg-zinc-800 text-zinc-400 rounded-lg cursor-not-allowed" title="Бот должен быть администратором канала">
          Включить
        </span>
      <% end %>

      <%= link_to edit_dashboard_channel_site_path(@channel_site),
                  class: 'px-4 py-2 border border-zinc-300 dark:border-zinc-700 rounded-lg hover:bg-zinc-50 dark:hover:bg-zinc-800 transition-colors' do %>
        Настройки
      <% end %>
    </div>
  </div>

  <!-- Bot Status Warning -->
  <% unless @channel_site.telegram_bot.can_create_channel_site? %>
    <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl p-6 mb-8">
      <div class="flex items-start gap-3">
        <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <div>
          <p class="font-medium text-red-800 dark:text-red-200">Бот не является администратором канала</p>
          <p class="text-sm text-red-700 dark:text-red-300 mt-1">
            Мини-сайт не будет работать, пока бот не будет добавлен администратором канала и верифицирован.
            <% if !@channel_site.telegram_bot.verified? %>
              Бот не верифицирован.
            <% end %>
          </p>
          <%= link_to 'Перейти к настройкам бота',
                      project_telegram_bot_path(@channel_site.project, @channel_site.telegram_bot),
                      class: 'inline-block mt-2 text-red-800 dark:text-red-200 underline hover:no-underline' %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Stats -->
  <div class="grid grid-cols-4 gap-6 mb-8">
    <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-6">
      <div class="text-3xl font-bold"><%= @stats[:total_posts] %></div>
      <div class="text-sm text-zinc-500 mt-1">Всего постов</div>
    </div>

    <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-6">
      <div class="text-3xl font-bold"><%= @stats[:published_posts] %></div>
      <div class="text-sm text-zinc-500 mt-1">Опубликовано</div>
    </div>

    <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-6">
      <div class="text-3xl font-bold"><%= number_with_delimiter(@stats[:total_views]) %></div>
      <div class="text-sm text-zinc-500 mt-1">Просмотров на сайте</div>
    </div>

    <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl p-6">
      <div class="text-3xl font-bold"><%= @stats[:featured_posts] %></div>
      <div class="text-sm text-zinc-500 mt-1">В избранном</div>
    </div>
  </div>

  <!-- Domain Verification -->
  <% if @channel_site.custom_domain.present? && !@channel_site.custom_domain_verified? %>
    <div class="bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-xl p-6 mb-8">
      <h3 class="font-semibold text-amber-800 dark:text-amber-200 mb-2">Подтвердите домен</h3>
      <p class="text-amber-700 dark:text-amber-300 text-sm mb-4">
        Добавьте TXT запись в DNS вашего домена:
      </p>
      <code class="block bg-amber-100 dark:bg-amber-900/40 px-4 py-2 rounded text-sm mb-4">
        contentforce-verify=<%= @channel_site.domain_verification_token %>
      </code>
      <%= button_to verify_domain_dashboard_channel_site_path(@channel_site),
                    method: :post,
                    class: 'px-4 py-2 bg-amber-500 hover:bg-amber-600 text-white rounded-lg transition-colors text-sm' do %>
        Проверить DNS
      <% end %>
    </div>
  <% end %>

  <!-- Recent Posts -->
  <div class="bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-xl">
    <div class="px-6 py-4 border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between">
      <h2 class="font-semibold">Последние посты</h2>
      <%= link_to 'Все посты', dashboard_channel_site_channel_posts_path(@channel_site),
                  class: 'text-emerald-500 hover:underline text-sm' %>
    </div>

    <% if @recent_posts.any? %>
      <div class="divide-y divide-zinc-200 dark:divide-zinc-800">
        <% @recent_posts.each do |post| %>
          <div class="px-6 py-4 flex items-center justify-between">
            <div class="flex-1">
              <h3 class="font-medium"><%= post.display_title&.truncate(60) %></h3>
              <div class="flex items-center gap-4 text-sm text-zinc-500 mt-1">
                <span><%= post.telegram_date.strftime('%d.%m.%Y') %></span>
                <span><%= post.views_count %> просмотров</span>
                <% if post.featured? %>
                  <span class="text-emerald-500">Избранное</span>
                <% end %>
                <% if post.hidden? %>
                  <span class="text-zinc-400">Скрыт</span>
                <% end %>
              </div>
            </div>
            <%= link_to edit_dashboard_channel_site_channel_post_path(@channel_site, post),
                        class: 'p-2 text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300 transition-colors' do %>
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
              </svg>
            <% end %>
          </div>
        <% end %>
      </div>
    <% else %>
      <div class="px-6 py-12 text-center text-zinc-500">
        Постов пока нет. Запустите синхронизацию для загрузки контента.
      </div>
    <% end %>
  </div>
</div>
